<?xml version='1.0' encoding='utf-8'?>
<project name="vhdllab" basedir="." default="default">

  <property name="configuration.properties" value="./configuration.properties"/>
  <property file="${configuration.properties}"/>

  <path id="src.class.path">
    <fileset dir="${lib.dir}">
      <include name="**/*.jar"/>
    </fileset>
    <pathelement path="${build.dir}/dao"/>
    <pathelement path="${build.dir}/service"/>
    <pathelement path="${build.dir}/web/onServer"/>
    <pathelement path="${build.dir}/web/onClient"/>
    <pathelement path="${build.dir}/tests/dao"/>
    <pathelement path="${build.dir}/tests/service"/>
    <pathelement path="${build.dir}/tests/web/onServer"/>
    <pathelement path="${build.dir}/tests/web/onClient"/>
  	<pathelement path="${build.dir}/i18n"/>
	<pathelement path="${build.dir}/i18n/common"/>
  </path>

  <target name="init">
    <available file="${configuration.properties}" property="configuration.properties.present"/>
    <fail unless="configuration.properties.present">
      ${configuration.properties} file is not present. You have a sample ${configuration.properties}-sample. Please copy this file under correct name and customize it.
    </fail>

    <available file="${lib.dir}/junit.jar" property="junit.jar.present"/>
    <fail unless="junit.jar.present">
      "${lib.dir}/junit.jar" file is not present. You can download it from http://www.junit.org.
    </fail>

    <available file="${lib.dir}/plugin.jar" property="plugin.jar.present"/>
    <fail unless="plugin.jar.present">
      "${lib.dir}/plugin.jar" file is not present. You can copy it from $JAVA_HOME/jre/lib/plugin.jar or $JRE_HOME/lib/plugin.jar.
    </fail>

    <available file="${lib.dir}/servlet-api.jar" property="servlet-api.jar.present"/>
    <fail unless="servlet-api.jar.present">
      "${lib.dir}/servlet-api.jar" file is not present. You can copy it from $CATALINA_HOME/common/lib/servlet-api.jar.
    </fail>

 	<tstamp/>
    
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${build.dir}/dao"/>
    <mkdir dir="${build.dir}/service"/>
    <mkdir dir="${build.dir}/web/onServer"/>
  	<mkdir dir="${build.dir}/web/onClient"/>
    <mkdir dir="${build.dir}/tests/dao"/>
    <mkdir dir="${build.dir}/tests/service"/>
    <mkdir dir="${build.dir}/tests/web/onServer"/>
    <mkdir dir="${build.dir}/tests/web/onClient"/>
    <mkdir dir="${jlib.dir}"/>
    <mkdir dir="${jlib-tests.dir}"/>
    <mkdir dir="${doc.dir}"/>
    <mkdir dir="${local.dir}"/>
    <mkdir dir="${hibernate.dir}"/>
  	
  	<copy todir="${local.dir}" overwrite="true">
  	  <fileset dir="${metadata.dir}"/>
	</copy>
  	
  	<replace dir="${local.dir}" propertyfile="${configuration.properties}">
  	  <replacefilter token="@@database.dialect@@" property="database.dialect"/>
	  <replacefilter token="@@database.driver@@" property="database.driver"/>
	  <replacefilter token="@@database.url@@" property="database.url"/>
   	  <replacefilter token="@@database.normal.username@@" property="database.normal.username"/>
   	  <replacefilter token="@@database.normal.password@@" property="database.normal.password"/>
	  <replacefilter token="@@database.show.sql@@" property="database.show.sql"/>
	  <replacefilter token="@@database.use.reflection.optimizer@@" property="database.use.reflection.optimizer"/>
  	  <replacefilter token="@@database.connection.pool.size@@" property="database.connection.pool.size"/>
  	  <replacefilter token="@@database.hbm2ddl.auto@@" property="database.hbm2ddl.auto"/>
  	</replace>
  </target>

  <target name="clean">
   <delete quiet="true" includeEmptyDirs="true">
      <fileset dir="${build.dir}"/>
      <fileset dir="${jlib-tests.dir}"/>
	  <fileset dir="${jlib.dir}"/>
      <fileset dir="${doc.dir}"/>
      <fileset dir="${hibernate.hbm.dir}"/>
      <fileset dir="${local.dir}"/>
    </delete>
  </target>

  <target name="compile-dao" depends="init">
    <javac destdir="${build.dir}/dao" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/dao"/>
      <src path="src/common/hr/fer/zemris/vhdllab/constants"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="compile-service" depends="compile-dao">
    <javac destdir="${build.dir}/service" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/service"/>
      <src path="src/common"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="compile-web-onServer" depends="compile-service">
    <javac destdir="${build.dir}/web/onServer" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/web/onServer"/>
      <src path="src/common"/>
      <src path="src/i18n/common"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>
	
  <target name="compile-web-onClient" depends="compile-service">
    <javac destdir="${build.dir}/web/onClient" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/web/onClient"/>
      <src path="src/common"/>
      <src path="src/i18n/common"/>
      <classpath refid="src.class.path"/>
    </javac>
  	<copy todir="src/web/onClient/hr/fer/zemris/vhdllab/applets/main" overwrite="true">
  	  <fileset dir="src/common/hr/fer/zemris/vhdllab/constants" excludes="**/*.java"/>
  	</copy>
  </target>

  <target name="package-dao" depends="compile-dao,hibernate-hbm">
    <jar destfile="${jlib.dir}/${app.name}-dao.jar">
      <fileset dir="${build.dir}/dao" includes="**/*.class"/>
      <fileset dir="src/dao" excludes="**/*.java"/>
	  <fileset dir="${local.dir}" includes="*.*"/>
	  <fileset dir="${hibernate.dir}"/>
    </jar>
  </target>

  <target name="package-service" depends="compile-service">
    <jar destfile="${jlib.dir}/${app.name}-service.jar">
      <fileset dir="${build.dir}/service" includes="**/*.class"/>
      <fileset dir="src/service" excludes="**/*.java"/>
    </jar>
  </target>

  <target name="package-web-onServer" depends="compile-web-onServer">
  	<jar destfile="${jlib.dir}/${app.name}-web-onServer.jar">
  	  <fileset dir="${build.dir}/web/onServer" includes="**/*.class"/>
      <fileset dir="src/web/onServer" excludes="**/*.java"/>
      <fileset dir="src/i18n/server" includes="**/*"/>
  	</jar>
  </target>
  
  <target name="package-web-onClient" depends="compile-web-onClient">
  	<jar destfile="${jlib.dir}/${app.name}-web-onClient.jar">
  	  <fileset dir="${build.dir}/web/onClient" includes="**/*.class"/>
          <fileset dir="src/web/onClient" excludes="**/*.java"/>
   	  <fileset dir="src/i18n/client" includes="**/*"/>
   	  <metainf dir="metadata/onClient/META-INF"/>
  	</jar>
  </target>
  
  <target name="compile-tests-dao" depends="compile-dao">
    <javac destdir="${build.dir}/tests/dao" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/tests/dao"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>
	
  <target name="compile-tests-service" depends="compile-service">
    <javac destdir="${build.dir}/tests/service" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/tests/service"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="compile-tests-web-onServer" depends="compile-web-onServer">
    <javac destdir="${build.dir}/tests/web/onServer" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/tests/web/onServer"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="compile-tests-web-onClient" depends="compile-web-onClient">
    <javac destdir="${build.dir}/tests/web/onClient" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/tests/web/onClient"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="package-tests-dao" depends="compile-tests-dao">
    <jar destfile="${jlib-tests.dir}/${app.name}-tests-dao.jar">
      <fileset dir="${build.dir}/tests/dao" includes="**/*.class"/>
    </jar>
  </target>
	
  <target name="package-tests-service" depends="compile-tests-service">
    <jar destfile="${jlib-tests.dir}/${app.name}-tests-service.jar">
      <fileset dir="${build.dir}/tests/service" includes="**/*.class"/>
    </jar>
  </target>
	
  <target name="package-tests-web-onServer" depends="compile-tests-web-onServer">
    <jar destfile="${jlib-tests.dir}/${app.name}-tests-web-onServer.jar">
      <fileset dir="${build.dir}/tests/web/onServer" includes="**/*.class"/>
    </jar>
  </target>

  <target name="package-tests-web-onClient" depends="compile-tests-web-onClient">
    <jar destfile="${jlib-tests.dir}/${app.name}-tests-web-onClient.jar">
      <fileset dir="${build.dir}/tests/web/onClient" includes="**/*.class"/>
    </jar>
  </target>
	
  <target name="run-tests-dao" depends="package-dao,package-tests-dao" if="junit.jar.present">
    <java fork="yes" classname="org.junit.runner.JUnitCore" taskname="junit" failonerror="true">
      <arg value="hr.fer.zemris.vhdllab.AllDAOJUnitTests"/>
      <classpath>
      	<pathelement location="${jlib.dir}/${app.name}-dao.jar"/>
        <pathelement location="${jlib-tests.dir}/${app.name}-tests-dao.jar"/>
        <pathelement location="${java.class.path}"/>
      	<path refid="src.class.path"/>
      </classpath>
    </java>
  </target>
	
  <target name="run-tests-service" depends="package-dao,package-service,package-tests-service" if="junit.jar.present">
    <java fork="yes" classname="org.junit.runner.JUnitCore" taskname="junit" failonerror="true">
      <arg value="hr.fer.zemris.vhdllab.AllServiceJUnitTests"/>
      <classpath>
      	<pathelement location="${jlib.dir}/${app.name}-service.jar"/>
      	<pathelement location="${jlib.dir}/${app.name}-dao.jar"/>
        <pathelement location="${jlib-tests.dir}/${app.name}-tests-service.jar"/>
        <pathelement location="${java.class.path}"/>
      	<path refid="src.class.path"/>
      </classpath>
    </java>
  </target>
     
  <target name="run-tests-web-onServer" depends="package-dao,package-service,package-web-onServer,package-tests-web-onServer" if="junit.jar.present">
    <java fork="yes" classname="org.junit.runner.JUnitCore" taskname="junit" failonerror="true">
      <arg value="hr.fer.zemris.vhdllab.AllOnServerJUnitTests"/>
      <classpath>
        <pathelement location="${jlib.dir}/${app.name}-web-onServer.jar"/>
      	<pathelement location="${jlib.dir}/${app.name}-service.jar"/>
      	<pathelement location="${jlib.dir}/${app.name}-dao.jar"/>
        <pathelement location="${jlib-tests.dir}/${app.name}-tests-web-onServer.jar"/>
        <pathelement location="${java.class.path}"/>
      	<path refid="src.class.path"/>
      </classpath>
    </java>
  </target>
	
  <target name="run-tests-web-onClient" depends="package-dao,package-service,package-web-onClient,package-tests-web-onClient" if="junit.jar.present">
    <java fork="yes" classname="org.junit.runner.JUnitCore" taskname="junit" failonerror="true">
      <arg value="hr.fer.zemris.vhdllab.AllOnClientJUnitTests"/>
      <classpath>
        <pathelement location="${jlib.dir}/${app.name}-web-onClient.jar"/>
      	<pathelement location="${jlib.dir}/${app.name}-service.jar"/>
      	<pathelement location="${jlib.dir}/${app.name}-dao.jar"/>
        <pathelement location="${jlib-tests.dir}/${app.name}-tests-web-onClient.jar"/>
        <pathelement location="${java.class.path}"/>
      	<path refid="src.class.path"/>
      </classpath>
    </java>
  </target>
	
  <target name="doc">
  	<javadoc 
  		access="public"
  		author="true"
  		classpathref="src.class.path"
  		destdir="${doc.dir}"
  		nodeprecated="false"
  		nodeprecatedlist="false"
  		noindex="false"
  		nonavbar="false"
  		notree="false"
  		packagenames="*"
  		source="1.5"
  		sourcepath="src/dao;src/service;src/web/onServer;src/web/onClient;src/i18n/common;src/common"
  		splitindex="true"
  		use="true"
  		version="true">
	  <link href="http://java.sun.com/j2se/1.5.0/docs/api/"/>
	</javadoc>
  </target>

  <target name="hibernate-hbm" depends="compile-dao">
    <taskdef name="xdoclet"
      classname="org.xdoclet.ant.XDocletTask"
      classpathref="src.class.path">
  	</taskdef>

	<xdoclet encoding="UTF-8">
	  <fileset dir="${model.dir}">
		<include name="**/*.java"/>
	  </fileset>
      <component
		classname="org.xdoclet.plugin.hibernate.HibernateMappingPlugin"
      	encoding="UTF-8"
		destdir="${hibernate.dir}"
		force="${hibernate.hbm.force}"
      	version="${hibernate.hbm.version}">
	  </component>

	  <component
	  	classname="org.xdoclet.plugin.hibernate.HibernateConfigPlugin"
	  	destdir="${hibernate.dir}"
	  	properties="${hibernate.dir}/hibernate.properties">
      </component>
	</xdoclet>

  	<replace dir="${hibernate.dir}">
  	  <include name="**/*.hbm.xml"/>
	  <replacetoken>access="method" </replacetoken>
  	</replace>
  	
  	<copy todir="bin">
  	  <fileset dir="${local.dir}">
  	  	<include name="*.*"/>
  	  </fileset>
  	  <fileset dir="${hibernate.dir}"/>
  	</copy>
  </target>
  	
  <target name="schema-export" depends="hibernate-hbm">
  	<input
	  message="Danger! Running this task will destroy existing database shema and create a new one. Loss of data is imminent! Are you sure you want to proceed?"
  	  validargs="y,n"
  	  addproperty="hibernate.run.task"/>
  	<condition property="do.abort">
  	  <equals arg1="n" arg2="${hibernate.run.task}"/>
  	</condition>
  	<fail if="do.abort">Build aborted by user.</fail>

  	<taskdef name="schemaexport"
      classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask"
      classpathref="src.class.path">
  	</taskdef>

  	<schemaexport
	  properties="${hibernate.dir}/hibernate.properties"
  	  quiet="no"
  	  text="no"
  	  drop="no"
  	  delimiter=";"
  	  output="${hibernate.dir}/schema-export.sql">
  	  <fileset dir="${hibernate.dir}">
 		<include name="**/*.hbm.xml"/>
  	  </fileset>
	</schemaexport>
  </target>
	
  <target name="tomcat" depends="package">
  	<property name="tomcat.app.dir" value="${tomcat.dir}${file.separator}webapps${file.separator}${app.name}"/>
  	<mkdir dir="${tomcat.app.dir}"/>
  	<mkdir dir="${tomcat.app.dir}${file.separator}WEB-INF"/>
  	<mkdir dir="${tomcat.app.dir}${file.separator}WEB-INF${file.separator}lib"/>
  	
    <copy todir="${tomcat.app.dir}" overwrite="true">
      <fileset dir="${basedir}/html/pages"/>
      <fileset file="${basedir}/${jlib.dir}/${app.name}-web-onClient.jar"/>
    </copy>
  	
    <copy todir="${tomcat.app.dir}${file.separator}WEB-INF" overwrite="true">
      <fileset dir="${basedir}/metadata/web"/>
    </copy>

  	<copy todir="${tomcat.app.dir}${file.separator}WEB-INF${file.separator}lib" overwrite="true">
      <fileset file="${basedir}/${jlib.dir}/${app.name}-dao.jar"/>
      <fileset file="${basedir}/${jlib.dir}/${app.name}-service.jar"/>
      <fileset file="${basedir}/${jlib.dir}/${app.name}-web-onServer.jar"/>
      <fileset file="${basedir}/${lib.dir}/*.*" excludes="servlet-api.jar"/>
      <fileset file="${basedir}/${lib.dir}/hibernate/*.*"/>
      <fileset file="${basedir}/${lib.dir}/mysql/*.*"/>
      <fileset file="${basedir}/${lib.dir}/xdoclet/*.*"/>
    </copy>
  </target>
	
  <target name="run-tomcat" depends="tomcat">
  	<property environment="env"/>
  	<condition property="">
  	  <isset property="${env.CATALINA_HOME}"/>
  	</condition>
    <exec executable="${tomcat.dir}${file.separator}bin${file.separator}${tomcat.exec}"
    	spawn="true">
    </exec>
  </target>
	
  <target name="run-app" depends="tomcat">
  	<!-- Sleep for tomcat to reload his resources -->
  	<sleep seconds="1"/>
    <exec executable="${browser}" spawn="true">
      <arg line="${browser.arg}"/>
      <arg line="http://${app.host}:${tomcat.port}/${app.name}/${app.url}"/>
    </exec>
  </target>

  <target name="compile" depends="compile-dao,compile-service,compile-web-onServer,compile-web-onClient"/>
	
  <target name="compile-tests" depends="compile-tests-dao,compile-tests-service,compile-tests-web-onServer,compile-tests-web-onClient"/>
	
  <target name="package" depends="package-dao,package-service,package-web-onServer,package-web-onClient"/>

  <target name="package-tests" depends="package-tests-dao,package-tests-service,package-tests-web-onServer,package-tests-web-onClient"/>
	
  <target name="run-tests" depends="run-tests-dao,run-tests-service,run-tests-web-onServer,run-tests-web-onClient"/>

  <target name="default" depends="package"/>
	
  <target name="hibernate" depends="schema-export"/>
	
  <target name="all" depends="package,doc,run-tests"/>
	
  <target name="rebuild" depends="clean,package"/>
	
  <target name="rebuild-all" depends="clean,package,doc,run-tests"/>
	
  <target name="rebuild-doc" depends="clean,doc"/>
  	
</project>