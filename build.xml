<!DOCTYPE project []>

<project name="Web Server" basedir="." default="package">

  <property name="app.name" value="web-server"/>
  
  <property name="build.dir" value="build"/>
  <property name="lib.dir" value="libs"/>
  <property name="jlib.dir" value="jlibs"/>

  <path id="src.class.path">
    <fileset dir="${lib.dir}">
      <include name="junit.jar"/>
      <include name="servlet-api.jar"/>
      <include name="plugin.jar"/>
   	  <include name="web-vhdl.jar"/>
    </fileset>
    <pathelement path="${build.dir}/dao"/>
    <pathelement path="${build.dir}/service"/>
    <pathelement path="${build.dir}/web"/>
    <pathelement path="${build.dir}/tests"/>
  </path>

 <target name="init">
    <available file="${lib.dir}/junit.jar" property="junit.jar.present"/>
    <fail unless="junit.jar.present">
      "${lib.dir}/junit.jar" file is not present.
    </fail>

    <available file="${lib.dir}/plugin.jar" property="plugin.jar.present"/>
    <fail unless="plugin.jar.present">
      "${lib.dir}/plugin.jar" file is not present. You can copy it from $JAVA_HOME/jre/lib/plugin.jar or $JRE_HOME/lib/plugin.jar.
    </fail>

    <available file="${lib.dir}/servlet-api.jar" property="servlet-api.jar.present"/>
    <fail unless="servlet-api.jar.present">
      "${lib.dir}/servlet-api.jar" file is not present. You can copy it from $CATALINA_HOME/common/lib/servlet-api.jar.
    </fail>
 	
    <available file="${lib.dir}/web-vhdl.jar" property="web-vhdl.jar.present"/>
     <fail unless="web-vhdl.jar.present">
       "${lib.dir}/web-vhdl.jar" file is not present. You must create it from Web VHDL project.
     </fail>

    <tstamp/>
    
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${build.dir}/web"/>
    <mkdir dir="${build.dir}/service"/>
    <mkdir dir="${build.dir}/dao"/>
    <mkdir dir="${build.dir}/tests"/>
    <mkdir dir="${jlib.dir}"/>
 </target>

  <target name="clean">
   <delete includeEmptyDirs="true">
      <fileset dir="${build.dir}"/>
      <fileset dir="${jlib.dir}"/>
    </delete>
  </target>

  <target name="compile-dao" depends="init">
    <javac destdir="${build.dir}/dao" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/dao"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="compile-service" depends="compile-dao">
    <javac destdir="${build.dir}/service" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/service"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="compile-web" depends="compile-service">
    <javac destdir="${build.dir}/web" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/web"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="package-dao" depends="compile-dao">
    <jar destfile="${jlib.dir}/${app.name}-dao.jar">
      <fileset dir="${build.dir}/dao" includes="**/*.class"/>
    </jar>
  </target>

  <target name="package-service" depends="compile-service">
    <jar destfile="${jlib.dir}/${app.name}-service.jar">
      <fileset dir="${build.dir}/service" includes="**/*.class"/>
    </jar>
  </target>
        
  <target name="package-web" depends="compile-web">
    <jar destfile="${jlib.dir}/${app.name}-webLib.jar">
      <fileset dir="${build.dir}/web" includes="hr/fer/zemris/vhdllab/servlets/**/*.class"/>
      <fileset dir="${build.dir}/web" includes="hr/fer/zemris/ajax/shared/**/*.class"/>
    </jar>
    <jar destfile="${jlib.dir}/${app.name}-webApplets.jar">
      <fileset dir="${build.dir}/web" includes="hr/fer/zemris/vhdllab/applets/**.class"/>
      <fileset dir="${build.dir}/web" includes="hr/fer/zemris/ajax/shared/**.class"/>
    </jar>
  </target>
        
        
  <target name="compile-tests" depends="compile-dao,compile-service,compile-web">
    <javac destdir="${build.dir}/tests" includes="**/*java" includeAntRuntime="false" debug="true" debuglevel="lines,vars,source" encoding="UTF-8">
      <src path="src/tests"/>
      <classpath refid="src.class.path"/>
    </javac>
  </target>

  <target name="package-tests" depends="compile-tests">
    <jar destfile="${jlib.dir}/${app.name}-tests.jar">
      <fileset dir="${build.dir}/tests" includes="**/*.class"/>
    </jar>
  </target>

  <target name="compile" depends="compile-dao,compile-service,compile-web"/>

  <target name="package" depends="package-dao,package-service,package-web"/>
        
  <!-- this target is currently invalid, since no tests are present -->
  <target name="run-tests" depends="package,package-tests" if="junit.jar.present">
    <java fork="yes" classname="junit.textui.TestRunner" taskname="junit" failonerror="true">
      <arg value="hr.fer.zemris.sekunde.tests.AllJunitTests"/>
      <classpath>
        <pathelement location="${jlib.dir}/${app.name}.jar"/>
        <pathelement location="${jlib.dir}/${app.name}-tests.jar"/>
        <pathelement location="${lib.dir}/junit.jar"/>
        <pathelement location="${java.class.path}"/>
      </classpath>
    </java>
  </target>
     
</project>
